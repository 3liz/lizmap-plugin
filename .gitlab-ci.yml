variables:
  GIT_SUBMODULE_STRATEGY: recursive

stages:
- package ðŸ“¦
- deploy ðŸš€

package:
  stage: package ðŸ“¦
  only:
    - schedules
  script:
    - >
      docker run
      --rm -w /plugin
      -v ${CI_PROJECT_DIR}:/plugin
      -u $(id -u):$(id -g)
      3liz/qgis-plugin-ci:1.8.4
      package ${CI_COMMIT_REF_NAME}
      --transifex-token ${TX_TOKEN}
      --allow-uncommitted-changes
      --disable-submodule-update
  after_script:
    - mv lizmap.${CI_COMMIT_REF_NAME}.zip lizmap-qgis-plugin.${CI_COMMIT_REF_NAME}.zip
  tags:
    - factory
  artifacts:
    paths:
    - lizmap-qgis-plugin.${CI_COMMIT_REF_NAME}.zip

deploy:
  stage: deploy ðŸš€
  only:
    - schedules
  script:
    - upload_to_packages_server lizmap-qgis-plugin.${CI_COMMIT_REF_NAME}.zip pub/lizmap-qgis-plugin/${CI_COMMIT_REF_NAME}
  tags:
    - fabric
